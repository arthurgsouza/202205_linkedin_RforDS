---
title: "Visualização de Dados"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Bibliotecas

```{r}
library(tidyverse)
```



# Intro

A etapa de visualização possui um papel importantíssimo no contexto de análise de dados, Ben Shneiderman, um importante nome da ciência da computação: "Visualização nos dá resposta para perguntas que nós não sabiamos que tinhamos". 


# O pacote ggplot2
E no R, apesar de existirem muitos recursos default para a visualização de dados, como as funções: `plot()`, `hist()` e `boxplot()`, é quando começamos a trabalhar com as bibliotecas de visualização do R, que o recurso gráfico é realmente potencializado. E sem dúvida o principal pacote para visualização no R, é o `ggplot2`. Neste, trabalhamos com a lógica do *Grammar of Graphics*, uma abstração lógica em que o gráfico é visto como um mapeamento feito por camadas, são elas:

```{r, eval=F}
  dados %>% 
    ggplot(aesthetic) +
      geometries(statistics) +
      facets() +
      coord()
      themes()
```


How do we express visuals in words?
Data to be visualized
Geometric objects that appear on the plot
Aesthetic mappings from data to visual component
Statistics transform data on the way to visualization
Coordinates organize location of geometric objects
Scales define the range of values for aesthetics
Facets group into subplots

Como expressamos o visual em palavras?
Dados a serem visualizados
Objetos geométricos que aparecem na plotagem
Mapeamentos estéticos de dados para componentes visuais
As estatísticas transformam os dados no caminho para a visualização
Coordenadas organizam a localização de objetos geométricos
As escalas definem o intervalo de valores para a estética
As facetas agrupam-se em subtramas

Contudo apenas três destas são obrigatórias: dados,  atributos estéticos (aesthetic), e objetos geométricos (geometries: pontos, barras, linhas, etc). Vamos começar por eles.


## camadas obrigatórias

Para as camadas obrigatórias, temos um layout similar a este:

```{r, eval=F}
  dados %>% 
    ggplot(aesthetic) +
      geometries() 
```



E para entender melhor do que se tratam, vamos adicioná-los um a um. Vamos utilizar aqui a base `drinks`, e no que ao aplicar o ggplot apenas, temos um painel em branco, com isto podemos entender que esta função tem como papel inicializar o gráfico:

```{r}
drinks <- fivethirtyeight::drinks
drinks %>% head()
```


```{r}
drinks %>% 
  ggplot() 
```
Passamos agora para o elemento `aesthetic`, no R esta função é representada de maneira abreviada, `aes()`. E por ser uma função, podemos pesquisar sobre, e então teremos que este "mapeamento estético" descreve como as variáveis dos dados serão mapeadas para propriedades visuais (estéticas) de geometrias. Não ajudou muito né? Mas traduzindo, o que estamos dizendo é que no `aes()` você indicará qual variável será mapeada no gráfico. Um mapeamente usual trata do eixo x e eixo y:


```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings)) 
```

Note que agora o gráfico passou a apresentar as variáveis nos eixos, mas nada além disto, por quê? Pois não indicamos como gostariamos que este gráfico apresentasse estes eixos. E para isto temos o nosso terceiro elemento obrigatório, as geometrias:


```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings)) +
  geom_point()
```
E poderíamos trabalhar com outra geometria. Qualquer uma? Não. Precisaria ser uma geometria que trabalhasse com dois eixos, sendo ambos numéricos, dado as variáveis escolhidas:

```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings)) +
    #geom_point()
    #geom_area() +
    #geom_bin_2d() +
    #geom_jitter()
    geom_rug()
```

Inclusive podemos usar mais de um layer, e fazendo ajustes nas geometrias de forma independente:

```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings)) +
    geom_point(aes(color = total_litres_of_pure_alcohol)) +
    #geom_area()
    #geom_bin_2d() +
    #geom_jitter()
    geom_rug(alpha = 0.2)
```

Mas quem são esses? 

```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings, color = total_litres_of_pure_alcohol)) +
    geom_point() +
    geom_text(aes(label = country))
```


Ruim de ler? 


```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings, color = total_litres_of_pure_alcohol)) +
    geom_point(alpha = 0.1) +
    geom_text(data = . %>% filter( total_litres_of_pure_alcohol > 10), aes(label = country))
```


```{r}
drinks %>% 
  ggplot(aes(x = beer_servings, y = wine_servings, color = total_litres_of_pure_alcohol)) +
    geom_point(alpha = 0.1) +
    ggrepel::geom_text_repel(data = . %>% filter( total_litres_of_pure_alcohol > 10), aes(label = country))
```

Aqui já estamos utilizando recursos avançados, mas o meu ponto era justo mostrar o quanto a dificuldade não é o código. Mas não se preocupe pois vamos passar por recursos suficientes para que você possa evoluir neste pacote ;)

No mais vale comentar também que o ggplot trabalha com o encadeamento de funções, porém a dinâmica aqui é um pouco diferente do `%>%` e por isso trabalhamos com o operador `+`.



## demais camadas 


<https://ggplot2.tidyverse.org/reference/>


Retornando a totalidade da camadas, temos ainda os níveis em que podemos fazer: a divisão de gráficos (faceting), sistemas de coordenadas (coord), temas de fundo (themes), e sumarizações estatísticas (statistics).


```{r, eval=F}
  dados %>% 
    ggplot(aesthetic) +
      geometries(statistics) +
      facets() +
      coord()
      themes()
```


E aqui vale dar uma checada na cheat sheet do ggplot, pois ela nos dá dicas valiosas sobre quais geometrias você pode ou não aplicar a depender do tipo da variável, além de sobre as demais camadas: 



```{r , echo=FALSE, fig.align = "center", fig.cap="CheatSheet ggplot2 (folha 01)"}
knitr::include_graphics('https://i.pinimg.com/originals/5d/f0/dd/5df0dd5a1c5751f039b8db8ad9267cb5.jpg')
```



## Parece legal, mas como eu supero a barreira de entrada? 

Treinando, fazendo uso das muitas excelentes referências existentes, e usando o pacote `esquisse::esquisser()` :) 


# Como fazer boas escolhas visuais?

Uma divisão interessante é separar a etapa de exploração, da etapa de explanação. Ou seja tratar de maneira diferente quando você está minerando o dado, procurando encontrar insights e validar hipóteses, e quando você já chegou em algo que será compartilhado, e deseja comunicar isto para outras pessoas.

# Exploração: qual gráfico usar? (geom_*)

Existem diferentes opções de geometria no ggplot, para citar alguns: 


- geom_line - para linhas definidas por pares (x,y).
- geom_abline - para retas definidas por um intercepto e uma inclinação.
- geom_hline - para retas horizontais.
- geom_bar - para barras.
- geom_histogram - para histogramas.
- geom_boxplot - para boxplots.
- geom_density - para densidades.
- geom_area - para áreas.

e existem vários pacotes que aumentam estas opções

Por meio do frame que relaciona a classe das variáveis ou o possível objetivo da análise com os gráficos:

>  <https://www.data-to-viz.com/>


Vamos ver algumas possíbilidades

```{r}
diamante <- dados::diamante %>%  glimpse()
```

## distribuição 

```{r}
library(titanic)
titanic <- titanic_train

# Gráfico

titanic %>%
  ggplot(aes(x = Age,y = ..density..,fill = Sex)) +
  geom_histogram(binwidth = 5,
                 position = "dodge",
                 col = "white",
                 boundary = 0,
                 alpha = 0.7) +
  facet_grid(~Sex,
             labeller = labeller(Sex = function(Sex) paste(Sex,
                                                           "passengers")))+
  scale_x_continuous(expand = c(0, 0))+
  labs(y = "Density")+
  theme_minimal()+
  theme(panel.grid.minor.y =element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none",
        panel.spacing = unit(1, "lines"),
        strip.text=element_text(hjust=0.8, vjust = -1.2)
  )
  
```


```{r}
titanic %>%
  ggplot(aes(x = Age, y = ..count..)) +
  geom_density(data = select(titanic, -Sex),
               aes(fill = "a"),
               color = "transparent",
               alpha = 0.6)+
  geom_density(aes(fill = Sex),
               color = "transparent")+
  scale_x_continuous(name = "age (years)",
                     limits = c(0, 85),
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 25),
                     name = "scaled density",
                     expand = c(0, 0))+
  scale_fill_manual(breaks = c("a", "female", "male"),
                    values = c("gray", "#D55E00", "#0072B2"),
                    labels=c("all","female","male"),
                    name = "")+
  facet_wrap(~Sex)+
  theme_minimal()+
  theme(panel.grid.minor.y =element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "bottom",
        legend.justification = "right",
        strip.text.x = element_blank())+
  ggtitle("Titanic Passengers Age by Sex")
```




## relação

```{r}
p <-  diamante %>% 
  sample_frac(0.10) %>% 
  ggplot(aes(x = quilate, y = preco)) +
  geom_point(aes(text = transparencia), size = 4) +
  geom_smooth(aes(colour = corte, fill = corte)) + 
  facet_grid(.~corte) 
plotly::ggplotly(p)
```






## ordenação 
Um  exemplo considerando a base `diamonds`, onde o interesse é entender a distribuição da variável `cut` em relação à `clarity`, ou ambas quanto a `count`:  


```{r}
  diamante %>% 
    ggplot(aes(x = corte, fill = transparencia)) + 
    geom_bar()
```


```{r}
 diamante %>% 
    ggplot(aes(x = corte,  y = preco)) + 
    geom_bar(aes(fill = transparencia), 
             stat = "identity", 
             position = "fill")
  
```




## evolução

Por fim segue um exemplo de dados temporais em que, em conjunto com as funções do `tidyr` e `dplyr`, remodelamos a base de dados `economics` visando obter a visualização das variáveis `psavert` e `uempmed` desde `1990`:

```{r}
economics %>%  glimpse()
```

```{r}
economics %>%
  select(date, psavert, uempmed) %>%
  filter(date>1990) %>% 
  pivot_longer(-date) %>% #() 
  #gather(key = "variable", value = "value", -date) %>% 
  ggplot(aes(x = date, y = value)) + 
  geom_line(aes(color = name), size = 1) 
```
# Explanação: como apresentar? 

isso além de todos as demais camadas

https://r4ds.had.co.nz/graphics-for-communication.html 


## demais layers do ggplot)

Respondendo: qual país bebe mais? 

### gráfico de barra

```{r}
paises <- c(paises <- c( "Argentina", "Brazil", "Uruguay", "Chile"))

# Colocando a base no formato tidy
drinks_tidy <- drinks %>%
  select(country,
         beer = beer_servings,
         spirit = spirit_servings,
         wine = wine_servings) %>%
  pivot_longer(beer:wine,
               names_to = "type",
               values_to = "servings") %>%
  filter(country %in% paises & type == "beer") %>%
  arrange(country, desc(servings))

# Grafico

drinks_tidy %>%
  ggplot(mapping = aes(x = reorder(country, servings), y = servings))+
  geom_col(position = "dodge", fill = "lightblue", width = 0.8, alpha = 0.8)+
  labs(x = "",
       y = "Servings per person (2010)",
       title = "Where Do People Drink The Most Beer?",
       caption = "Source: World Health Organization (FiveThirtyEight)")+
  scale_y_continuous(limits = c(0,260), expand = c(0, 0))+
  theme_minimal()+
  theme(panel.grid.major.y =element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.caption = element_text(hjust = 0, vjust = -0.5,size = 8))+
  coord_flip()
```


### dot plot

```{r}
# Selecionando os paises
top20 <- drinks %>%
  select(country,
         beer = beer_servings,
         spirit = spirit_servings,
         wine = wine_servings) %>%
  pivot_longer(beer:wine,
               names_to = "type",
               values_to = "servings") %>%
  filter(type == "beer") %>%
  arrange(country, desc(servings)) %>%
  top_n(20, servings)

# Grafico 

top20 %>%
  ggplot(mapping = aes(x = servings, y = reorder(country, servings)))+
  geom_point(col = "darkgreen", size = 3)+
  labs(x = "Servings per person (2010)",
       y = "",
       title = "Where Do People Drink The Most Beer? (Top 20)",
       caption = "Source: World Health Organization (FiveThirtyEight)")+
  scale_x_continuous(limits = c(250,380),expand = c(0, 0))+
  theme_minimal()+
  theme(plot.caption = element_text(hjust = 0, vjust = -0.5,size = 8))
```


### barra agrupada

```{r}
paises <- c(paises <- c("China", "Italy", "Saudi Arabia", "USA"))
drinks_tidy <- drinks %>%
  select(country,
         beer = beer_servings,
         spirit = spirit_servings,
         wine = wine_servings) %>%
  pivot_longer(beer:wine,
               names_to = "type",
               values_to = "servings") %>%
  filter(country %in% paises) %>%
  arrange(type, desc(servings))

# Gráfico

drinks_tidy %>%
  ggplot(mapping = aes(x = country, y = servings, fill = type))+
  geom_col(position = "dodge")+
  geom_text(aes(label = ifelse(servings == 0, "", servings)),
            position = position_dodge(width = 1),
            vjust = -0.5, size = 3) +
  scale_y_continuous(limits = c(0,260), expand = c(0, 0))+
  labs(x = "", y = "", fill = "Type",
       title = "Who Drinks The Most Beer, Spirits and Wine?",
       subtitle = "Servings Per Person (2010)",
       caption = "Source: World Health Organization (FiveThirtyEight)")+
  theme_minimal()+
  theme(axis.line=element_blank(), panel.border =element_blank(), panel.grid.major.x =element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.caption = element_text(hjust = 0, vjust = 7,size = 8))+
  scale_fill_brewer(palette = "Pastel1")

```

# Explanação: próximos passos! 

Existem mais de 350 pacotes relacionados ao pacote ggplot2, oferecendo recursos 

Poderiam fácil ter mais algumas horas de curso só apra falar sobre isto

Pacotes úteis (em ordem alfabética):

{cowplot} — arranjos de enredo, temas e anotações
{ggalt} — coordenadas alternativas, geoms, estatísticas e escalas
{gganimate} — cria animações
{ggbump} — geoms para gráficos de colisão
{ggforce} — vários recursos adicionais interessantes
{ggiraph} — geoms para visualizações dinâmicas e interativas
{ggmaps} — acesso aos mapas do Google e Stamen
{ggplotly} — cria gráficos interativos
{ggraph} — redes, gráficos e árvores
{ggrepel} — evita a sobreposição de rótulos de texto
{ggridges} — geoms para plotagens de ridgeline
{ggsankey} — geoms para diagramas sankey
{ggstream} — geoms para gráficos de fluxo
{ggtext} — renderização em rich text
{ggthemes} — temas, escalas e geometrias adicionais
{hrbrthemes} — temas mínimos centrados em tipografia
{lemon} — complementos de eixo e legenda
{patchwork} — combine ggplots com gráficos de vários painéis
{rayshader} — mapas sombreados em 2D e 3D
{systemfonts} — use fontes personalizadas (substitui {extrafont} e {showtext})

olçha até onde podemos chegar!  [ggplot Wizardry](https://www.cedricscherer.com/slides/OutlierConf2021_ggplot-wizardry.pdf)


# Bônus: Tabelas

Por fim gostaria de comentar de uma entidade tão importante quanto o gráfico em si: as tabelas. Eu tenho um amigo, que costuma dizer que "por tras de todo grande gráfico temos uma grande tabela". O que faz sentido, inclusive, se você reparar para vários dos nossos exemplos foi necessário fazer algum ajuste nos dados antes de chegar no gráfico:

## DT
Default do knitr
```{r}
drinks %>% DT::datatable()
```

## Outras opções de bibliotecas

- [kableExtra](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)

- [flextable](https://ardata-fr.github.io/flextable-book/)


# Hands-on

No RStudio Learn Primers: https://rstudio.cloud/learn/primers, faça os exercícios propostos na aba Visualize Data,  https://rstudio.cloud/learn/primers/3 





